@model List<ListingProjectsDTO>
@{
  ViewData["Title"] = "Dashboard";
  //var listingMd = Model?.FirstOrDefault();
}
<!DOCTYPE html>
<html>
<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width"/>
    <title>TestDashboard1</title>
    <style>
        .listing {
            margin: 10px;
            padding: 10px;
            width: 45%; /* Make each listing take up roughly half the container */
            border: 1.5px outset darkgray;
            box-shadow: 0 0 2px #aca9a9;
            border-radius: 6px;
        }
        .wrapper {
            display: flex;
            flex-wrap: wrap; /* Allows listings to wrap to the next line if necessary */
            gap: 10px; /* Adds spacing between listing items */
        }
        .listing img {
            width: 100%;
            height: auto;
        }
        .roundPlaceholder {
            width: 60px;
            height: 20px;
            background: #a84909;
            border-radius: 10px;
        }
        .roundPlaceholderTxt {
            font-size: 10px;
            font-family: Arial;
            text-align: center;
            color: aliceblue;
        }
        .listingPhoto {
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
<div class="wrapper">
    @foreach (var listingMd in Model)
    {
        @if (listingMd != null)
        {
            <div class="listing" data-id="@listingMd.ListingId">
                <div><img class="listingPhoto" src="~/imgSearchHome/IMG_20220102_161928.jpg" /></div>
                <div class="content">
                    <p>Test index: <span class="view-mode listing-name">@listingMd.ListingName_DTO</span>
                        <input type="text" class="edit-mode form-control listing-name-input" value="@listingMd.ListingName_DTO" style="display: none;" />
                    </p>
                    <p>Age: <span class="view-mode listing-age">@listingMd.ListingId</span></p>
                    <div class="roundPlaceholder">
                        <p class="roundPlaceholderTxt">Book me</p>
                    </div>
                    <div class="deleteListingBtn">
                        <a type="button" class="delete" data-entity-id="@listingMd.ListingId" class="btn btn-danger">Delete</a>
                    </div>
                    <div class="editListingBtn">
                        <button type="button" class="btn btn-warning edit-btn view-mode">Edit</button>
                        <button type="button" class="btn btn-success save-btn edit-mode" style="display: none;">Save</button>
                        <button type="button" class="btn btn-secondary cancel-btn edit-mode" style="display: none;">Cancel</button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <p>No listings available.</p>
        }
    }
</div>

<script type="text/javascript">
    $(document).ready(function () {
        $(".edit-btn").click(function () {
            // Show edit mode
            var parent = $(this).closest(".listing");
            parent.find(".view-mode").hide();
            parent.find(".edit-mode").show();
        });

        $(".cancel-btn").click(function () {
            // Cancel editing and revert to view mode
            var parent = $(this).closest(".listing");
            parent.find(".edit-mode").hide();
            parent.find(".view-mode").show();
        });

        $(".save-btn").click(function () {
            // Save changes via AJAX
            var parent = $(this).closest(".listing");
            var id = parent.data("id");
            var newName = parent.find(".listing-name-input").val();

            $.ajax({
                type: "POST",
                url: "@Url.Action("Update", "Home")",
                data: {
                    ListingId: id,
                    ListingName_DTO: newName,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() // Anti-forgery token
                },
                success: function (response) {
                    if (response.success) {
                        // Update view mode content
                        parent.find(".listing-name").text(newName);
                        parent.find(".edit-mode").hide();
                        parent.find(".view-mode").show();
                    } else {
                        alert("Error saving changes: " + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    alert("Error: " + error);
                }
            });
        });
        $(".delete").click(function (e) {
            e.preventDefault(); // Prevent default action

            var button = $(this); // Reference the clicked button
            var id = button.data("entity-id"); // Get the ID from data-entity-id attribute

            $.ajax({
                type: "POST",
                url: "@Url.Action("DeleteDetails", "Home")", // Correct action for deletion
                data: {
                    id: id,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() // Anti-forgery token
                },
                dataType: "json", // Expect JSON response
                success: function (data, status, xhr) {
                    if (data === "success!") {
                        button.closest(".listing").hide("slow"); // Hide card on success
                    } else {
                        alert("Error: " + data); // Display error message
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error: " + status + " " + error + " " + xhr.status + " " + xhr.statusText);
                }
            });
        });
    });
</script>

</body>
</html>
